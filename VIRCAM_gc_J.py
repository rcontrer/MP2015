#FG
import numpy as np
import glob
import os

#!!!!!!!!!!!!!!!!!!!
#!                 !
#! AUTHOR COMMENTS !
#!                 !
#!!!!!!!!!!!!!!!!!!!

#
#  Port a python por Felipe Gran, fgran@astro.puc.cl
#  INPUT DEL USUARIO
#

search_text = '*k*.dao'  # Texto para hacer busqueda de archivo/s ('*k*.dao', 'b242_3_k_11-028.dao')
skip_header = 3          # Numero de lineas del header
x_col = 1                # Numero (desde 0) de columna de x
y_col = 2                # Numero (desde 0) de columna de y
nchip = 11               # Numero de chip a corregir
path = '/Users/apple/Dropbox/Magister/Cursos/InvestigacionC/matias/python_Libralato/' #path to files

#
#  FIN MODIFICACIONES
#

#! Padova, March 31 2015
#!
#! This is a FORTRAN routine to correct the geometric distortion of
#! VIRCAM@VISTA detector released with the paper Libralato et al. (2015).
#!
#! A typical run will look like:
#!
#!       call VIRCAM_gc_J(xraw,yraw,chipnumber,xcorr,ycorr)
#!
#!
#! The use of this distortion solution is encouraged regardless of the
#! specific method adopted to measure stellar positions. Each meta catalog
#! is projected into a plane tangential to its center. This offers the
#! best single-catalog, distortion-free positions. Please note that, in
#! order to construct a common reference frame, all meta catalogs should
#! be instead projected into the same tangent plane
#!
#!
#! Please acknowledge the use of this routine in any published work tha
#! make use of it.  The proper citation is the paper:
#!
#!       Libralato et al. (2015), arXiv: 1503.07519
#!
#!
#! Kind regards,
#!
#!       Mattia Libralato



#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#!                                                                !
#!     This file contains 4 subroutines:                          !
#!                                                                !
#!     SUBROUTINES:                                               !
#!                                                                !
#!     1) VIRCAM_gc_J(xr,yr,chip,xc,yc)                           !
#!     2) vvv_gc(xr,yr,chip,xc,yc)                                !
#!     3) table_adjust(xr,yr,chip,xm,ym,xc,yc)                    !
#!     4) basic_gc_biquad(xraw,yraw,xcor,ycor,xtab,ytab)          !
#!                                                                !
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



#! This subroutine applies the full J-filter geometric-distortion
#! correction.
#! Inputs: (x,y) raw coordinates, chip number
#! Outputs: (x,y) corrected coordinates

def VIRCAM_gc_J(xr,yr,chip):
    """
    xr,yr ! Raw coordinates
    xm,ym ! Coordinates corrected with the 3x3 table of residuals
    xc,yc ! Final corrected coordinates
    chip  ! Chip number
    """

    #! 3x3 table of residuals correction
    xm, ym = vvv_gc(xr,yr,chip)

    #! 11x11 table of residuals correction
    xc, yc = table_adjust(xr,yr,chip,xm,ym)

    return xc, yc



#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#!                                     !
#! 11x11 TABLE OF RESIDUALS CORRECTION !
#!                                     !
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

def table_adjust(xr,yr,chip,xm,ym):
    """
    xr, xr ! Raw coordinates
    chip         ! Chip number
    xm, ym   ! Coordinates corrected only with the 3x3 table of residuals
    xcor_new, ycor_new ! Final corrected coordinates
    xchip(11,11,16), ychip(11,11,16) ! Table of residuals
    """

    #CHIP=01
    xchip=[[(-0.0351,-0.0005,0.0202,0.0246,0.0189,0.0087,-0.0029,-0.0171,-0.0304,-0.034,-0.0302),
    (-0.0489,-0.0141,0.0067,0.011,0.006,-0.0022,-0.0123,-0.0237,-0.0331,-0.0344,-0.0284),
    (-0.0593,-0.0243,-0.0033,0.0011,-0.003,-0.0097,-0.0184,-0.0279,-0.0345,-0.0336,-0.0253),
    (-0.0677,-0.033,-0.0115,-0.0062,-0.0104,-0.0146,-0.0219,-0.0312,-0.0376,-0.0343,-0.0222),
    (-0.0711,-0.0365,-0.0146,-0.0077,-0.0087,-0.0126,-0.0196,-0.0294,-0.0342,-0.0295,-0.0162),
    (-0.0743,-0.0387,-0.0154,-0.0062,-0.0053,-0.0083,-0.0146,-0.0234,-0.0284,-0.0221,-0.0071),
    (-0.0794,-0.0432,-0.0185,-0.0058,-0.0029,-0.0044,-0.009,-0.0151,-0.0187,-0.0115,0.0041),
    (-0.0862,-0.0469,-0.0193,-0.0053,-0.0001,0,-0.0015,-0.0048,-0.0049,0.0023,0.0165),
    (-0.0931,-0.0512,-0.0208,-0.0044,0.0043,0.007,0.0072,0.006,0.008,0.0152,0.0277),
    (-0.1027,-0.0573,-0.0234,-0.0031,0.0081,0.0142,0.0162,0.0161,0.0179,0.0248,0.0371),
    (-0.1132,-0.0644,-0.027,-0.0016,0.0123,0.022,0.0255,0.0263,0.0262,0.0329,0.045)],
    #CHIP=02
    [(-0.0553,-0.002,0.0341,0.051,0.0485,0.0337,0.0143,-0.0001,-0.0106,-0.0118,-0.0035),
    (-0.0705,-0.0202,0.0127,0.0272,0.0233,0.0087,-0.0086,-0.0215,-0.0283,-0.0252,-0.0125),
    (-0.0794,-0.0322,-0.0022,0.0098,0.0047,-0.0095,-0.0251,-0.0356,-0.0386,-0.0311,-0.0141),
    (-0.0794,-0.0379,-0.0119,-0.0026,-0.0071,-0.0207,-0.0354,-0.0423,-0.0402,-0.0283,-0.0063),
    (-0.0765,-0.0393,-0.0167,-0.0094,-0.0157,-0.0285,-0.0412,-0.0455,-0.0403,-0.0243,0.0024),
    (-0.0678,-0.0368,-0.0182,-0.0129,-0.019,-0.0312,-0.0426,-0.0444,-0.0362,-0.0172,0.0125),
    (-0.0537,-0.0288,-0.0142,-0.0106,-0.016,-0.0267,-0.0364,-0.0369,-0.0258,-0.0049,0.0264),
    (-0.0335,-0.0146,-0.0036,-0.0012,-0.0054,-0.0146,-0.0232,-0.0222,-0.0097,0.0124,0.0451),
    (-0.0065,0.0078,0.0157,0.0169,0.0124,0.0031,-0.005,-0.0039,0.0081,0.0316,0.0663),
    (0.024,0.0362,0.0419,0.0412,0.035,0.0244,0.015,0.0158,0.0284,0.0527,0.0883),
    (0.0606,0.0706,0.0741,0.0715,0.0628,0.0496,0.0375,0.0373,0.0508,0.0759,0.1123)],
    #CHIP=03
    [(-0.0626,-0.0165,0.0118,0.0207,0.0135,-0.0018,-0.0188,-0.031,-0.0336,-0.0235,-0.0009),
    (-0.0567,-0.0122,0.0144,0.0208,0.0129,-0.002,-0.0171,-0.0266,-0.0254,-0.0122,0.0133),
    (-0.0505,-0.0077,0.0173,0.0221,0.0138,-0.0009,-0.0143,-0.0218,-0.0176,-0.0014,0.0272),
    (-0.0436,-0.0039,0.0192,0.0242,0.0161,0.0014,-0.0107,-0.0163,-0.0098,0.0085,0.0398),
    (-0.0379,0,0.0219,0.0261,0.0188,0.0054,-0.0065,-0.0114,-0.0041,0.0154,0.048),
    (-0.032,0.0033,0.0238,0.0286,0.0214,0.0088,-0.0028,-0.0068,-0.0006,0.0186,0.0506),
    (-0.0247,0.0085,0.028,0.0326,0.0254,0.0131,0.0021,-0.002,0.0028,0.0202,0.0496),
    (-0.0173,0.0158,0.0352,0.0382,0.0309,0.0189,0.0086,0.0026,0.0051,0.0197,0.0463),
    (-0.0116,0.0219,0.0416,0.0455,0.0385,0.0264,0.0146,0.0063,0.005,0.0165,0.0396),
    (-0.0071,0.0274,0.048,0.0528,0.0454,0.0319,0.0175,0.0062,0.0014,0.0091,0.0283),
    (-0.003,0.0325,0.0541,0.0604,0.0525,0.0366,0.0186,0.0037,-0.0052,-0.0014,0.014)],
    #CHIP=04
    [(-0.0474,-0.0218,-0.0057,0.0022,-0.0001,-0.0053,-0.0058,-0.0004,0.0226,0.062,0.1171),
    (-0.0546,-0.026,-0.0071,0.0035,0.0024,-0.0053,-0.015,-0.0146,-0.0041,0.027,0.0738),
    (-0.0606,-0.0291,-0.0072,0.0054,0.005,-0.0053,-0.0217,-0.027,-0.0252,-0.0022,0.0362),
    (-0.0666,-0.0282,-0.0027,0.0112,0.0096,-0.0042,-0.0222,-0.0359,-0.041,-0.0239,0.0097),
    (-0.0692,-0.0276,-0.0001,0.0155,0.0118,-0.005,-0.0243,-0.0431,-0.0538,-0.0383,-0.0037),
    (-0.0677,-0.0264,0.0008,0.017,0.013,-0.0054,-0.0275,-0.047,-0.0582,-0.0413,-0.0038),
    (-0.0603,-0.0239,0.0002,0.0157,0.0113,-0.0052,-0.0271,-0.0455,-0.0548,-0.0329,0.0122),
    (-0.0448,-0.0166,0.0015,0.0126,0.0091,-0.0044,-0.0249,-0.0408,-0.0415,-0.0126,0.0412),
    (-0.0214,-0.0028,0.008,0.0138,0.0092,-0.0051,-0.0211,-0.0304,-0.0213,0.0166,0.0807),
    (0.0077,0.0187,0.022,0.0213,0.012,-0.0031,-0.0163,-0.0191,-0.0019,0.0454,0.1189),
    (0.0421,0.0455,0.0413,0.0326,0.0159,-0.0005,-0.0117,-0.0084,0.0178,0.0746,0.1575)],
    #CHIP=05
    [(0.1097,0.101,0.0803,0.0435,0.0083,-0.0128,-0.02,-0.0134,0.0057,0.0353,0.0726),
    (0.0663,0.0696,0.0608,0.0399,0.0182,0.0037,-0.0039,-0.0033,0.0052,0.0257,0.054),
    (0.025,0.0402,0.0434,0.0346,0.0231,0.0139,0.006,0.0022,0.0026,0.014,0.0332),
    (-0.0126,0.014,0.0282,0.0301,0.0255,0.0195,0.0124,0.0048,-0.0014,0.002,0.0114),
    (-0.0368,-0.0043,0.0158,0.0247,0.0254,0.022,0.0139,0.0045,-0.0043,-0.005,-0.0014),
    (-0.0489,-0.0143,0.0082,0.021,0.0243,0.0206,0.0127,0.0035,-0.005,-0.0062,-0.0039),
    (-0.0488,-0.0174,0.0033,0.0157,0.02,0.0156,0.0067,-0.0011,-0.0056,-0.0027,0.0045),
    (-0.0343,-0.0123,0.0013,0.01,0.0119,0.0051,-0.0039,-0.0083,-0.0067,0.0034,0.0201),
    (-0.0046,0.0019,0.0033,0.0029,-0.0011,-0.0112,-0.0206,-0.0213,-0.0118,0.0089,0.0395),
    (0.0287,0.0223,0.0106,-0.0036,-0.0172,-0.0325,-0.0421,-0.039,-0.0202,0.0107,0.0516),
    (0.0649,0.0455,0.0207,-0.0121,-0.0385,-0.0611,-0.0713,-0.064,-0.0342,0.007,0.0581)],
    #CHIP=06
    [(-0.0879,-0.0091,0.048,0.0793,0.0868,0.0757,0.0555,0.034,0.0168,0.0143,0.025),
    (-0.0727,-0.0055,0.0401,0.0589,0.0571,0.0422,0.0255,0.0122,0.0076,0.0149,0.0353),
    (-0.0569,-0.0011,0.0329,0.0413,0.0328,0.0158,0.0021,-0.0047,0.0006,0.0176,0.0478),
    (-0.0428,-0.0001,0.0234,0.0222,0.0088,-0.0076,-0.0178,-0.0189,-0.006,0.0199,0.0607),
    (-0.0339,-0.0011,0.0151,0.0087,-0.0059,-0.0211,-0.0292,-0.0263,-0.0089,0.022,0.0688),
    (-0.0317,-0.0031,0.0105,0.0032,-0.011,-0.0248,-0.0317,-0.0273,-0.0093,0.0226,0.0706),
    (-0.0381,-0.0077,0.0076,0.0031,-0.0092,-0.0215,-0.0277,-0.0253,-0.0097,0.0187,0.0622),
    (-0.0528,-0.0132,0.009,0.009,-0.0003,-0.0107,-0.0177,-0.0185,-0.0087,0.0118,0.0449),
    (-0.072,-0.0196,0.0125,0.02,0.0159,0.0076,-0.0013,-0.0076,-0.0066,0.0025,0.0213),
    (-0.0887,-0.0262,0.0162,0.0334,0.0349,0.0279,0.0159,0.0025,-0.0075,-0.0103,-0.0035),
    (-0.1028,-0.0301,0.0225,0.0516,0.0596,0.0543,0.0381,0.0153,-0.0083,-0.023,-0.0282)],
    #CHIP=07
    [(-0.1491,-0.0796,-0.0306,-0.0054,0.0023,0.0035,-0.0002,-0.0023,0.0009,0.018,0.0472),
    (-0.1085,-0.045,-0.0019,0.0166,0.0192,0.0161,0.0089,0.0035,0.0038,0.0185,0.0453),
    (-0.0747,-0.0171,0.0199,0.0329,0.0312,0.0244,0.0143,0.0061,0.0039,0.0163,0.0407),
    (-0.0474,0.0034,0.0345,0.0427,0.0375,0.0281,0.0158,0.0053,0.0005,0.0117,0.0351),
    (-0.0296,0.0153,0.0413,0.0455,0.037,0.0258,0.0131,0.002,-0.0041,0.0072,0.0318),
    (-0.0209,0.0195,0.0417,0.0426,0.0312,0.0189,0.0075,-0.0027,-0.0076,0.0052,0.0319),
    (-0.0203,0.0162,0.0355,0.0344,0.0216,0.009,-0.0016,-0.0095,-0.0108,0.0046,0.0342),
    (-0.0263,0.0066,0.0236,0.0219,0.0093,-0.0034,-0.0138,-0.0195,-0.0163,0.0033,0.0374),
    (-0.0395,-0.0099,0.0052,0.0046,-0.0073,-0.0199,-0.0295,-0.0325,-0.0248,-0.0008,0.0382),
    (-0.061,-0.0318,-0.0171,-0.018,-0.0297,-0.0414,-0.0489,-0.0492,-0.0383,-0.0098,0.0336),
    (-0.0881,-0.0593,-0.045,-0.0461,-0.0573,-0.068,-0.0731,-0.0706,-0.0563,-0.0234,0.0244)],
    #CHIP=08
    [(-0.0507,-0.0141,0.0076,0.0125,0.0046,-0.0012,-0.004,0.0036,0.0223,0.0578,0.1093),
    (-0.0389,-0.0057,0.0126,0.0139,0.0025,-0.0084,-0.014,-0.0092,0.0089,0.0439,0.0948),
    (-0.0294,0.0004,0.0154,0.0132,-0.0006,-0.0151,-0.0228,-0.0199,-0.0021,0.0322,0.0826),
    (-0.0235,0.0026,0.0145,0.0093,-0.0068,-0.023,-0.0321,-0.0294,-0.0128,0.0212,0.0721),
    (-0.0187,0.0046,0.0142,0.0073,-0.0107,-0.027,-0.0357,-0.0328,-0.0171,0.0159,0.0653),
    (-0.0132,0.0078,0.0156,0.0073,-0.011,-0.0252,-0.0324,-0.0294,-0.0152,0.0173,0.0661),
    (-0.0065,0.0115,0.0179,0.01,-0.0055,-0.018,-0.0229,-0.0196,-0.005,0.0277,0.0764),
    (0.0022,0.0172,0.0224,0.0158,0.0043,-0.0061,-0.0088,-0.0046,0.0109,0.0461,0.0979),
    (0.0135,0.0261,0.0302,0.0253,0.0161,0.0097,0.0076,0.0133,0.0315,0.071,0.1288),
    (0.0265,0.0387,0.0425,0.0372,0.0287,0.0232,0.0236,0.0322,0.055,0.099,0.1612),
    (0.0422,0.0541,0.0576,0.0506,0.0423,0.0365,0.0398,0.0517,0.0811,0.1296,0.1962)],
    #CHIP=09
    [(-0.0845,-0.0214,0.0244,0.0484,0.0523,0.0425,0.0211,-0.0048,-0.0284,-0.0435,-0.0487),
    (-0.0711,-0.0159,0.022,0.0387,0.0391,0.0299,0.0152,0,-0.0114,-0.0147,-0.008),
    (-0.057,-0.0098,0.0202,0.0307,0.0279,0.019,0.0094,0.0027,0.0018,0.0104,0.0288),
    (-0.041,-0.0048,0.0167,0.0204,0.0156,0.0075,0.0004,0,0.0092,0.0294,0.0617),
    (-0.0279,-0.0008,0.0138,0.013,0.0062,-0.0018,-0.0077,-0.0037,0.0133,0.0422,0.0848),
    (-0.0185,0.0013,0.0109,0.0071,-0.0021,-0.0105,-0.0153,-0.0089,0.0134,0.0476,0.0963),
    (-0.0144,0.0021,0.0087,0.0017,-0.0077,-0.0165,-0.0196,-0.0122,0.0113,0.0474,0.0987),
    (-0.011,0.0037,0.0087,0.0006,-0.0094,-0.0171,-0.0204,-0.0133,0.0074,0.0415,0.0909),
    (-0.0085,0.0068,0.0121,0.0042,-0.0068,-0.0154,-0.0189,-0.0157,-0.0015,0.0265,0.0698),
    (-0.0037,0.0123,0.0183,0.0112,0,-0.0107,-0.0192,-0.0226,-0.016,0.0042,0.0396),
    (0.004,0.0209,0.0277,0.0219,0.0107,-0.0027,-0.0189,-0.0319,-0.036,-0.0236,0.004)],
    #CHIP=10
    [(-0.1733,-0.1273,-0.0961,-0.0788,-0.0714,-0.0647,-0.0563,-0.0402,-0.0134,0.0326,0.0967),
    (-0.1137,-0.0734,-0.0479,-0.041,-0.0444,-0.0482,-0.049,-0.041,-0.0208,0.0198,0.0785),
    (-0.0664,-0.0318,-0.012,-0.0124,-0.0233,-0.0342,-0.0415,-0.0398,-0.0255,0.0096,0.0629),
    (-0.035,-0.0042,0.0114,0.0061,-0.0084,-0.0228,-0.0334,-0.0367,-0.0269,0.0025,0.0494),
    (-0.0207,0.0082,0.0225,0.0169,0.0022,-0.0122,-0.0246,-0.03,-0.0246,-0.0005,0.0392),
    (-0.0203,0.0094,0.025,0.0224,0.0105,-0.0022,-0.0143,-0.0211,-0.0187,0,0.0328),
    (-0.032,0.0026,0.0227,0.0248,0.0174,0.0071,-0.0034,-0.0105,-0.0107,0.003,0.0286),
    (-0.0542,-0.0105,0.0171,0.0247,0.0229,0.0167,0.008,0.0007,-0.0011,0.0083,0.027),
    (-0.0859,-0.0317,0.0052,0.0219,0.0256,0.0236,0.0177,0.012,0.0087,0.0142,0.0263),
    (-0.1261,-0.0622,-0.0155,0.0103,0.0212,0.0243,0.0218,0.0173,0.0131,0.0162,0.0258),
    (-0.1736,-0.1,-0.0437,-0.0072,0.0119,0.021,0.0224,0.0199,0.0153,0.016,0.0233)],
    #CHIP=11
    [(0.1444,0.1332,0.1138,0.0848,0.054,0.0268,0.0079,0.0029,0.0188,0.0572,0.1141),
    (0.0822,0.0819,0.0734,0.0576,0.0376,0.0186,0.0042,0,0.0114,0.0453,0.0979),
    (0.0267,0.0373,0.0398,0.0351,0.0239,0.0117,0.0011,-0.0025,0.0053,0.0348,0.0829),
    (-0.0196,0.002,0.0144,0.0196,0.0158,0.0082,0.0012,-0.0013,0.0043,0.0283,0.0674),
    (-0.053,-0.0239,-0.0051,0.0066,0.0081,0.0037,-0.0002,-0.002,0.0024,0.0232,0.0568),
    (-0.0697,-0.0378,-0.0164,-0.0021,0.0015,-0.001,-0.0041,-0.0047,0.0006,0.0201,0.0513),
    (-0.0692,-0.0397,-0.0197,-0.0061,-0.0034,-0.0067,-0.0094,-0.0083,-0.0021,0.0185,0.0508),
    (-0.0506,-0.0278,-0.0133,-0.0035,-0.0047,-0.0111,-0.0146,-0.012,-0.0025,0.0202,0.0545),
    (-0.0139,-0.0015,0.0037,0.0048,-0.0026,-0.0133,-0.0182,-0.0147,-0.0017,0.0253,0.0649),
    (0.0344,0.0364,0.0314,0.022,0.0061,-0.0103,-0.0175,-0.0132,0.0025,0.0336,0.0773),
    (0.0923,0.0839,0.0687,0.0461,0.0195,-0.0045,-0.015,-0.0098,0.0091,0.0442,0.0919)],
    #CHIP=12
    [(-0.1542,-0.0954,-0.0534,-0.0302,-0.0184,-0.0103,-0.0043,0.003,0.0174,0.0456,0.0861),
    (-0.1164,-0.0625,-0.0254,-0.0088,-0.0046,-0.0026,-0.0022,-0.0005,0.0094,0.034,0.071),
    (-0.0859,-0.0369,-0.0048,0.0068,0.006,0.0038,0.0005,-0.0015,0.0047,0.0258,0.0593),
    (-0.0639,-0.0196,0.0081,0.0156,0.013,0.0097,0.005,0.001,0.0049,0.0229,0.0523),
    (-0.052,-0.0124,0.012,0.0175,0.0156,0.0132,0.0102,0.0057,0.0069,0.0233,0.0511),
    (-0.0487,-0.0122,0.0102,0.0156,0.0153,0.0154,0.0142,0.0106,0.0122,0.0283,0.0551),
    (-0.0538,-0.0189,0.0032,0.0096,0.0117,0.0143,0.0151,0.0143,0.0176,0.0349,0.0627),
    (-0.0634,-0.0301,-0.0077,0.0009,0.006,0.0102,0.0121,0.0134,0.0198,0.0412,0.0738),
    (-0.0771,-0.0453,-0.0225,-0.0106,-0.0027,0.0022,0.0069,0.0109,0.0225,0.0481,0.0852),
    (-0.098,-0.0643,-0.0395,-0.0259,-0.0153,-0.0064,0.0019,0.0101,0.0265,0.0573,0.0995),
    (-0.1228,-0.0871,-0.0604,-0.0451,-0.0309,-0.0166,-0.0038,0.0099,0.0314,0.0673,0.1147)],
    #CHIP=13
    [(-0.0888,-0.0346,0.0033,0.0224,0.0322,0.0345,0.0318,0.0262,0.0254,0.0297,0.0405),
    (-0.0614,-0.0129,0.0193,0.0333,0.0364,0.0325,0.0229,0.0134,0.0073,0.0093,0.0179),
    (-0.0376,0.0052,0.0318,0.0403,0.0377,0.0288,0.0145,0.0017,-0.0079,-0.0082,-0.0018),
    (-0.0176,0.019,0.0402,0.0429,0.0356,0.0224,0.0051,-0.0104,-0.0204,-0.0225,-0.0185),
    (-0.0031,0.027,0.0432,0.0415,0.0313,0.0148,-0.0025,-0.0181,-0.0299,-0.0324,-0.0282),
    (0.0046,0.0288,0.0407,0.0382,0.0252,0.0085,-0.0085,-0.0227,-0.0341,-0.0356,-0.0305),
    (0.0074,0.0258,0.034,0.0319,0.0181,0.0028,-0.0136,-0.0247,-0.0346,-0.0324,-0.0226),
    (0.011,0.0248,0.0299,0.0256,0.0122,-0.0018,-0.0148,-0.0236,-0.0289,-0.0204,-0.0019),
    (0.0149,0.0245,0.0268,0.0212,0.0088,-0.0056,-0.0162,-0.0194,-0.0177,-0.0018,0.0258),
    (0.0238,0.0313,0.0315,0.024,0.01,-0.0036,-0.0122,-0.0107,-0.0025,0.0213,0.0571),
    (0.0375,0.0429,0.0409,0.0317,0.0146,0.0016,-0.0053,0.0008,0.0156,0.0475,0.0913)],
    #CHIP=14
    [(-0.0637,-0.0287,-0.0051,0.0063,0.0079,0.0032,-0.0041,-0.0086,-0.0002,0.0268,0.0721),
    (-0.0531,-0.0208,0,0.0084,0.0068,-0.0002,-0.0095,-0.0162,-0.0099,0.0169,0.0621),
    (-0.0451,-0.0155,0.0025,0.0085,0.0044,-0.0043,-0.0149,-0.0226,-0.0172,0.0095,0.0545),
    (-0.0413,-0.0145,0.0016,0.0053,-0.0004,-0.0103,-0.0219,-0.0286,-0.0224,0.0039,0.0483),
    (-0.042,-0.0166,-0.0013,0.0019,-0.0035,-0.0139,-0.0252,-0.0313,-0.0233,0.0028,0.046),
    (-0.0476,-0.0204,-0.0036,0.0012,-0.0039,-0.0144,-0.0237,-0.0277,-0.0193,0.0062,0.0476),
    (-0.0555,-0.0263,-0.0069,0.0011,-0.0013,-0.0097,-0.0174,-0.0197,-0.0101,0.014,0.0522),
    (-0.0678,-0.0336,-0.0095,0.0032,0.005,-0.0006,-0.0058,-0.0063,0.0031,0.0255,0.0602),
    (-0.0809,-0.041,-0.0115,0.0065,0.0147,0.0128,0.0098,0.0108,0.0197,0.0408,0.0728),
    (-0.0947,-0.0487,-0.0131,0.0113,0.0239,0.0263,0.026,0.028,0.0367,0.057,0.0881),
    (-0.1079,-0.0557,-0.0141,0.0175,0.0348,0.0416,0.0445,0.0474,0.0561,0.0756,0.1058)],
    #CHIP=15
    [(-0.0972,-0.0568,-0.0296,-0.0174,-0.0177,-0.0324,-0.0528,-0.0687,-0.0701,-0.0545,-0.0225),
    (-0.0701,-0.0328,-0.0086,0.0004,-0.0021,-0.0183,-0.038,-0.0524,-0.0515,-0.0335,0.0008),
    (-0.0461,-0.0119,0.0091,0.0157,0.0115,-0.0052,-0.0241,-0.0371,-0.034,-0.0136,0.0232),
    (-0.0255,0.005,0.0232,0.0267,0.0218,0.0069,-0.0107,-0.023,-0.0174,0.0047,0.044),
    (-0.0102,0.0166,0.0326,0.0357,0.0312,0.0175,0.0009,-0.0101,-0.0045,0.0181,0.0582),
    (-0.0031,0.0227,0.0381,0.041,0.0375,0.0258,0.011,0.0001,0.0035,0.0256,0.0651),
    (-0.0051,0.0221,0.0389,0.0436,0.0411,0.0302,0.017,0.0073,0.0091,0.0288,0.0646),
    (-0.0132,0.0177,0.0373,0.0442,0.0423,0.033,0.0208,0.0115,0.0128,0.0291,0.0594),
    (-0.026,0.0095,0.033,0.0441,0.0432,0.0324,0.0207,0.0115,0.0134,0.0248,0.047),
    (-0.0411,-0.0016,0.0256,0.0396,0.0399,0.0288,0.0158,0.0046,0.002,0.0101,0.029),
    (-0.0586,-0.0152,0.0158,0.0331,0.0344,0.022,0.0065,-0.0072,-0.0166,-0.0118,0.0037)],
    #CHIP=16
    [(-0.0064,0.0162,0.0305,0.0349,0.0299,0.0178,0.0032,-0.0089,-0.0101,0.0001,0.0209),
    (-0.0065,0.015,0.0282,0.032,0.0269,0.0146,0.0005,-0.0104,-0.0108,0,0.0214),
    (-0.0062,0.0142,0.0262,0.0296,0.0246,0.0122,-0.0012,-0.0107,-0.0105,0.0009,0.0229),
    (-0.0072,0.0138,0.0256,0.0269,0.0212,0.0107,-0.0014,-0.0098,-0.0099,0.002,0.0247),
    (-0.0082,0.013,0.0248,0.0254,0.0202,0.0097,-0.0004,-0.008,-0.0059,0.0049,0.0251),
    (-0.0097,0.0107,0.0224,0.0247,0.0209,0.011,0.0009,-0.0051,-0.0004,0.0094,0.0264),
    (-0.0121,0.0068,0.0184,0.0235,0.0213,0.0132,0.0052,0.0001,0.0023,0.011,0.0265),
    (-0.016,0.0042,0.0175,0.0231,0.0229,0.017,0.0093,0.0051,0.0064,0.011,0.02),
    (-0.0229,0.0002,0.0163,0.0225,0.025,0.0181,0.0103,0.0048,0.0037,0.0037,0.0056),
    (-0.0364,-0.0103,0.0086,0.0181,0.0214,0.0152,0.0066,-0.0007,-0.0056,-0.0101,-0.0126),
    (-0.0549,-0.0259,-0.0041,0.011,0.0147,0.0089,-0.0011,-0.0101,-0.0198,-0.0287,-0.0357)]]

    #CHIP=01
    ychip=[[(-0.2024,-0.1786,-0.1566,-0.1346,-0.1148,-0.0938,-0.0709,-0.0509,-0.031,-0.0183,-0.0094),
    (-0.1567,-0.1388,-0.1227,-0.1112,-0.0994,-0.0854,-0.0684,-0.0499,-0.0338,-0.0215,-0.013),
    (-0.1243,-0.1122,-0.102,-0.0974,-0.0914,-0.0824,-0.0691,-0.0518,-0.0376,-0.0257,-0.0175),
    (-0.1088,-0.103,-0.0986,-0.0974,-0.0942,-0.0873,-0.0747,-0.0588,-0.0412,-0.0301,-0.0229),
    (-0.1015,-0.0983,-0.097,-0.0986,-0.0988,-0.0933,-0.0815,-0.0653,-0.0498,-0.0386,-0.0303),
    (-0.097,-0.0943,-0.094,-0.0984,-0.1015,-0.098,-0.0868,-0.0725,-0.0574,-0.0489,-0.0441),
    (-0.0971,-0.0917,-0.0903,-0.0984,-0.1021,-0.0968,-0.0876,-0.0756,-0.0638,-0.059,-0.0586),
    (-0.0941,-0.0867,-0.0834,-0.0881,-0.0903,-0.0851,-0.076,-0.0655,-0.0584,-0.0596,-0.067),
    (-0.0874,-0.074,-0.0664,-0.0664,-0.0661,-0.0589,-0.0498,-0.0415,-0.0406,-0.0494,-0.067),
    (-0.0705,-0.0525,-0.0401,-0.0361,-0.0325,-0.0242,-0.0158,-0.0112,-0.0163,-0.0324,-0.0572),
    (-0.0435,-0.0208,-0.0038,0.0043,0.0113,0.0211,0.0289,0.0287,0.0176,-0.0057,-0.0379)],
    #CHIP=02
    [(-0.0097,-0.0177,-0.026,-0.034,-0.0387,-0.042,-0.0419,-0.0392,-0.0365,-0.0355,-0.0366),
    (0.0026,-0.0007,-0.0045,-0.008,-0.0098,-0.0112,-0.0121,-0.0106,-0.0097,-0.01,-0.0125),
    (0.0037,0.0048,0.0056,0.0059,0.0069,0.0071,0.0062,0.0072,0.0072,0.0055,0.0016),
    (-0.0088,-0.0017,0.0035,0.0075,0.01,0.0111,0.013,0.0148,0.014,0.0109,0.0053),
    (-0.023,-0.0124,-0.0044,0.0015,0.0061,0.0087,0.0115,0.0141,0.0141,0.0103,0.0027),
    (-0.0376,-0.0251,-0.0157,-0.0091,-0.0035,0.0013,0.0051,0.0086,0.0093,0.0056,-0.0024),
    (-0.0459,-0.0341,-0.0249,-0.0182,-0.012,-0.0064,-0.0008,0.0036,0.0051,0.0024,-0.0044),
    (-0.0455,-0.0365,-0.0292,-0.0234,-0.0169,-0.0112,-0.0055,0.0002,0.0032,0.0034,-0.0006),
    (-0.0338,-0.0295,-0.0257,-0.0215,-0.016,-0.0105,-0.005,0.0024,0.0103,0.0143,0.0144),
    (-0.0099,-0.0089,-0.0083,-0.0078,-0.0045,0.0005,0.0072,0.0175,0.0299,0.0383,0.0427),
    (0.025,0.0228,0.0201,0.0152,0.0156,0.0199,0.0281,0.0424,0.0608,0.0736,0.0824)],
    #CHIP=03
    [(-0.0272,-0.0359,-0.0452,-0.0532,-0.0573,-0.0558,-0.0465,-0.0329,-0.0151,0.0019,0.0186),
    (0.0137,0.0073,0.0003,-0.0073,-0.012,-0.0122,-0.0072,0.0013,0.0113,0.0224,0.033),
    (0.0376,0.0336,0.0289,0.0222,0.0176,0.0162,0.0182,0.0227,0.0266,0.0316,0.0361),
    (0.0419,0.0419,0.0401,0.0341,0.0306,0.0287,0.029,0.03,0.0301,0.0293,0.0267),
    (0.035,0.0381,0.0385,0.0367,0.0334,0.0307,0.0309,0.0303,0.0276,0.0219,0.0123),
    (0.0227,0.0296,0.0328,0.0319,0.0303,0.0289,0.0297,0.0278,0.0229,0.0145,0.0015),
    (0.01,0.0185,0.0233,0.0237,0.0227,0.0232,0.0243,0.0233,0.017,0.007,-0.0079),
    (-0.0008,0.0077,0.013,0.0142,0.0156,0.0176,0.0195,0.019,0.0137,0.0046,-0.0097),
    (-0.0052,0.002,0.0073,0.0108,0.013,0.0155,0.0196,0.0219,0.0195,0.0116,-0.002),
    (-0.001,0.0065,0.012,0.0156,0.0188,0.0231,0.0297,0.0346,0.0353,0.0304,0.0195),
    (0.0111,0.019,0.0248,0.0278,0.0319,0.0385,0.0482,0.0565,0.0613,0.0592,0.0512)],
    #CHIP=04
    [(0.1109,0.0576,0.009,-0.0344,-0.0744,-0.1019,-0.1205,-0.1248,-0.1158,-0.0918,-0.0565),
    (0.1237,0.0788,0.0386,0.0053,-0.0214,-0.0421,-0.0561,-0.0615,-0.0523,-0.0307,0.002),
    (0.1221,0.0857,0.054,0.0288,0.0113,-0.0041,-0.0145,-0.0194,-0.0109,0.0082,0.0385),
    (0.1061,0.0773,0.0533,0.0354,0.0207,0.0106,0.0011,-0.001,0.0055,0.0212,0.0458),
    (0.0809,0.0615,0.0443,0.0307,0.0176,0.0112,0.0067,0.008,0.0153,0.0257,0.0407),
    (0.0532,0.0419,0.0307,0.0205,0.01,0.0056,0.0059,0.0094,0.0172,0.0227,0.029),
    (0.0289,0.0235,0.017,0.0105,0.0033,0.0002,0.0014,0.0049,0.0093,0.0108,0.0111),
    (0.0126,0.0112,0.0081,0.0048,0.0007,-0.0007,-0.0013,-0.0007,0,-0.0023,-0.0071),
    (0.0069,0.0076,0.0063,0.0048,0.0021,0.002,0.0008,-0.0025,-0.0058,-0.0107,-0.0178),
    (0.0121,0.0138,0.0134,0.0119,0.0089,0.0079,0.006,0.0012,-0.0035,-0.0108,-0.0203),
    (0.026,0.0287,0.0294,0.0259,0.0214,0.0177,0.0155,0.0112,0.0058,-0.0039,-0.0157)],
    #CHIP=05
    [(0.0317,0.027,0.0238,0.021,0.0204,0.0151,0.0072,-0.004,-0.0197,-0.0413,-0.0666),
    (0.0357,0.0309,0.0277,0.0262,0.0245,0.022,0.0179,0.0122,0.0033,-0.0119,-0.0309),
    (0.0334,0.0285,0.0252,0.0245,0.0225,0.022,0.021,0.0198,0.0165,0.0075,-0.0052),
    (0.0239,0.0192,0.0158,0.0133,0.0129,0.0129,0.0142,0.0157,0.0173,0.0138,0.0073),
    (0.0117,0.0055,0.001,-0.001,-0.0005,0.0007,0.0035,0.0072,0.0118,0.0122,0.0103),
    (0.0006,-0.0064,-0.0117,-0.015,-0.0148,-0.0122,-0.0077,-0.0024,0.0035,0.0057,0.0064),
    (-0.0016,-0.0102,-0.0169,-0.0222,-0.023,-0.0198,-0.015,-0.0096,-0.0035,-0.0008,0.0005),
    (0.0043,-0.0036,-0.0107,-0.019,-0.0219,-0.0198,-0.0159,-0.0111,-0.0062,-0.004,-0.003),
    (0.0238,0.0166,0.0092,0.0006,-0.0055,-0.005,-0.0034,-0.0004,0.0034,0.0045,0.0044),
    (0.0674,0.0598,0.052,0.0426,0.0348,0.0322,0.0315,0.0322,0.0342,0.0341,0.0328),
    (0.1322,0.1242,0.1161,0.1059,0.0965,0.0897,0.0861,0.0841,0.0836,0.0823,0.0797)],
    #CHIP=06
    [(-0.0653,-0.062,-0.0627,-0.0645,-0.0687,-0.0619,-0.0464,-0.0317,-0.0199,-0.0054,0.0091),
    (-0.0124,-0.0072,-0.0059,-0.0083,-0.0139,-0.0103,0.0011,0.0111,0.0172,0.0258,0.0343),
    (0.0208,0.0279,0.0311,0.0294,0.0237,0.0251,0.0334,0.0391,0.0396,0.0421,0.0447),
    (0.0348,0.0429,0.047,0.049,0.0458,0.0458,0.0503,0.0518,0.0463,0.0443,0.0414),
    (0.0378,0.044,0.0474,0.052,0.0505,0.0494,0.0514,0.0497,0.0417,0.0371,0.0309),
    (0.0331,0.0345,0.0356,0.0393,0.0374,0.0361,0.0366,0.0352,0.0294,0.0249,0.0189),
    (0.0303,0.026,0.0226,0.0218,0.0192,0.0176,0.0187,0.0195,0.0182,0.0164,0.0133),
    (0.0369,0.0249,0.0152,0.0089,0.0043,0.0019,0.0039,0.0073,0.0095,0.0135,0.0177),
    (0.056,0.0348,0.0174,0.0052,-0.0041,-0.0068,-0.0041,0.0016,0.0087,0.0204,0.0346),
    (0.0837,0.0553,0.0307,0.0121,-0.0011,-0.006,-0.0016,0.0089,0.0229,0.0423,0.0643),
    (0.1206,0.085,0.0532,0.0268,0.0093,0.0018,0.0087,0.0257,0.0485,0.0757,0.1054)],
    #CHIP=07
    [(-0.0287,-0.0266,-0.0244,-0.0213,-0.0192,-0.0188,-0.0174,-0.0148,-0.0088,0.002,0.0176),
    (0.0003,-0.0001,-0.0005,-0.0014,-0.004,-0.0068,-0.0095,-0.0099,-0.0069,0.0022,0.016),
    (0.0175,0.0144,0.0112,0.0075,0.0022,-0.0024,-0.0073,-0.0096,-0.0084,-0.001,0.011),
    (0.0211,0.0148,0.009,0.0033,-0.0019,-0.0068,-0.0113,-0.014,-0.0139,-0.0077,0.0026),
    (0.0149,0.0056,-0.0021,-0.0088,-0.0136,-0.0175,-0.0193,-0.0212,-0.0216,-0.0155,-0.0049),
    (0.0059,-0.006,-0.0158,-0.0232,-0.028,-0.0302,-0.0305,-0.0305,-0.0296,-0.0227,-0.0116),
    (0,-0.0146,-0.0261,-0.0343,-0.0393,-0.041,-0.0406,-0.0386,-0.0354,-0.0259,-0.0125),
    (0.0033,-0.0134,-0.0268,-0.0368,-0.0423,-0.0438,-0.042,-0.0378,-0.0307,-0.0173,0.0002),
    (0.0214,0.0019,-0.0134,-0.0253,-0.0312,-0.0327,-0.0288,-0.0212,-0.0083,0.0107,0.0345),
    (0.0595,0.038,0.0206,0.0074,0.0011,0.0007,0.0075,0.0198,0.0386,0.0638,0.0937),
    (0.1161,0.0926,0.0732,0.0586,0.0521,0.0536,0.0636,0.0818,0.1079,0.1392,0.1753)],
    #CHIP=08
    [(0.0271,0.0166,0.0081,0.002,-0.0031,-0.0096,-0.0166,-0.0245,-0.0379,-0.05,-0.0614),
    (0.0391,0.027,0.0169,0.0076,0.0007,-0.0041,-0.0068,-0.0085,-0.0106,-0.0147,-0.0181),
    (0.0409,0.0272,0.0154,0.0041,-0.0037,-0.0072,-0.0066,-0.0033,0.0031,0.007,0.0115),
    (0.029,0.0138,0.001,-0.011,-0.0205,-0.0243,-0.0219,-0.0128,-0.0007,0.0099,0.0221),
    (0.009,-0.0044,-0.0162,-0.0292,-0.0378,-0.0409,-0.0359,-0.0243,-0.0092,0.0055,0.0224),
    (-0.0126,-0.0242,-0.0341,-0.0438,-0.0503,-0.0511,-0.0443,-0.0319,-0.0165,-0.0002,0.0184),
    (-0.0335,-0.0406,-0.0468,-0.0527,-0.0556,-0.054,-0.0467,-0.0341,-0.02,-0.0045,0.0129),
    (-0.0471,-0.0471,-0.0477,-0.0492,-0.0494,-0.0462,-0.0393,-0.0283,-0.015,-0.0033,0.0093),
    (-0.0402,-0.032,-0.0258,-0.0218,-0.0198,-0.0173,-0.0119,-0.0045,0.005,0.01,0.0151),
    (0.0038,0.0182,0.0306,0.0395,0.0439,0.0454,0.0466,0.0479,0.0489,0.0472,0.0454),
    (0.0803,0.1009,0.1195,0.1339,0.1407,0.1401,0.1345,0.1265,0.115,0.1065,0.0979)],
    #CHIP=09
    [(0.0406,0.0482,0.0529,0.0542,0.0532,0.0498,0.042,0.0304,0.0158,-0.0009,-0.0194),
    (0.0596,0.0648,0.0671,0.0647,0.0613,0.0559,0.0476,0.0371,0.025,0.0104,-0.0058),
    (0.0663,0.069,0.0689,0.0639,0.059,0.0525,0.0442,0.0346,0.0246,0.0123,-0.0017),
    (0.057,0.0575,0.0556,0.0495,0.0432,0.0362,0.0288,0.02,0.0118,0.0018,-0.0093),
    (0.0373,0.0383,0.0365,0.03,0.0225,0.0166,0.0097,0.0023,-0.0053,-0.013,-0.0211),
    (0.014,0.0172,0.0171,0.0121,0.0057,-0.0009,-0.0064,-0.0113,-0.0175,-0.0232,-0.0294),
    (-0.0052,0.0004,0.0027,0.0009,-0.0043,-0.0101,-0.0151,-0.0184,-0.0214,-0.0243,-0.0279),
    (-0.018,-0.0088,-0.0034,-0.0017,-0.0049,-0.009,-0.013,-0.0139,-0.0127,-0.011,-0.0097),
    (-0.018,-0.0063,0.0017,0.0065,0.007,0.0051,0.0029,0.0049,0.0129,0.0212,0.03),
    (0.0001,0.0145,0.0254,0.0329,0.0358,0.0369,0.0392,0.0475,0.0618,0.0772,0.0931),
    (0.0346,0.0518,0.0653,0.0755,0.0807,0.085,0.0927,0.1093,0.1318,0.1544,0.1774)],
    #CHIP=10
    [(0.0517,0.0493,0.0445,0.0356,0.0268,0.0192,0.0143,0.0134,0.0137,0.0132,0.0108),
    (0.0385,0.0399,0.0389,0.0363,0.0322,0.0276,0.0248,0.0255,0.0274,0.0267,0.0241),
    (0.0206,0.0258,0.0285,0.0304,0.0298,0.0273,0.0262,0.028,0.0308,0.0299,0.027),
    (-0.0033,0.0065,0.0126,0.0164,0.0172,0.0168,0.0178,0.0197,0.0219,0.0208,0.0177),
    (-0.0213,-0.0107,-0.0039,0.0004,0.0016,0.002,0.0041,0.0069,0.0089,0.0073,0.0029),
    (-0.0294,-0.0215,-0.0168,-0.0142,-0.0134,-0.0119,-0.0099,-0.0065,-0.0043,-0.0058,-0.0107),
    (-0.0262,-0.0241,-0.0241,-0.0245,-0.0256,-0.0249,-0.0225,-0.0188,-0.0159,-0.0152,-0.0174),
    (-0.0066,-0.0138,-0.0211,-0.0267,-0.0311,-0.0328,-0.031,-0.0266,-0.0214,-0.0166,-0.013),
    (0.0355,0.0172,0.0003,-0.0133,-0.0235,-0.0287,-0.0291,-0.0233,-0.0128,-0.0017,0.0105),
    (0.1054,0.0772,0.0505,0.027,0.0088,-0.0015,-0.0036,0.0037,0.0195,0.0373,0.0561),
    (0.1998,0.1618,0.1254,0.09,0.0615,0.0443,0.0399,0.0493,0.0715,0.0958,0.1213)],
    #CHIP=11
    [(-0.0653,-0.0709,-0.0745,-0.0758,-0.0774,-0.08,-0.0836,-0.0875,-0.0927,-0.0937,-0.0914),
    (-0.0143,-0.0213,-0.0264,-0.0291,-0.0315,-0.0342,-0.037,-0.0398,-0.0428,-0.0418,-0.0375),
    (0.0176,0.0091,0.0026,-0.0013,-0.0045,-0.0073,-0.0093,-0.0112,-0.0122,-0.0091,-0.0028),
    (0.0275,0.017,0.009,0.0035,0,-0.0033,-0.0048,-0.0051,-0.0031,0.0015,0.0092),
    (0.0265,0.0147,0.0054,-0.001,-0.0062,-0.0095,-0.0112,-0.0101,-0.0074,-0.0009,0.0089),
    (0.0204,0.0069,-0.0032,-0.0102,-0.0159,-0.0204,-0.0226,-0.0206,-0.0169,-0.0089,0.0023),
    (0.0093,-0.0047,-0.0155,-0.0228,-0.0281,-0.0329,-0.0353,-0.0329,-0.0272,-0.0174,-0.0043),
    (-0.0027,-0.0176,-0.029,-0.0359,-0.0411,-0.0457,-0.0476,-0.0447,-0.0361,-0.0241,-0.0085),
    (-0.0085,-0.0244,-0.0369,-0.0447,-0.0508,-0.0548,-0.0563,-0.0522,-0.0417,-0.0265,-0.0067),
    (0,-0.0172,-0.0309,-0.0402,-0.0469,-0.0512,-0.0521,-0.0458,-0.0326,-0.0146,0.008),
    (0.0198,0.0013,-0.0135,-0.0252,-0.0328,-0.0378,-0.038,-0.029,-0.0126,0.0082,0.0338)],
    #CHIP=12
    [(-0.058,-0.0569,-0.0547,-0.0499,-0.0465,-0.0427,-0.035,-0.0267,-0.0213,-0.0153,-0.0101),
    (-0.0064,-0.0077,-0.008,-0.008,-0.0087,-0.0078,-0.0015,0.008,0.0162,0.0228,0.0286),
    (0.0278,0.0241,0.0213,0.0183,0.015,0.014,0.0193,0.0293,0.0387,0.0459,0.0523),
    (0.0399,0.0359,0.032,0.0265,0.0216,0.0202,0.0261,0.0349,0.0448,0.0519,0.0581),
    (0.0379,0.034,0.0301,0.0247,0.0203,0.0187,0.024,0.0331,0.0405,0.0463,0.0507),
    (0.0266,0.0241,0.0215,0.0179,0.0144,0.0147,0.0194,0.0269,0.0325,0.0353,0.0357),
    (0.0112,0.0106,0.0102,0.0095,0.0088,0.0112,0.017,0.0229,0.0264,0.0251,0.0199),
    (-0.0019,0.0009,0.0036,0.0049,0.0082,0.0134,0.0189,0.0234,0.023,0.0187,0.0095),
    (-0.0054,0.0007,0.0065,0.0121,0.0182,0.0246,0.0306,0.0355,0.0324,0.0243,0.0098),
    (0.0105,0.0201,0.0293,0.0375,0.0453,0.0529,0.0595,0.0634,0.059,0.0484,0.0313),
    (0.0437,0.0566,0.0692,0.0795,0.0883,0.097,0.1041,0.1072,0.1027,0.0895,0.07)],
    #CHIP=13
    [(-0.0594,-0.0692,-0.0807,-0.0959,-0.1142,-0.1338,-0.1571,-0.181,-0.2043,-0.2225,-0.2377),
    (-0.0246,-0.0313,-0.0396,-0.0508,-0.0624,-0.0745,-0.0909,-0.1081,-0.1234,-0.1356,-0.1448),
    (-0.0069,-0.0103,-0.0155,-0.0229,-0.029,-0.0347,-0.0447,-0.0555,-0.0639,-0.07,-0.0732),
    (-0.0079,-0.0097,-0.012,-0.0144,-0.017,-0.0181,-0.0202,-0.0233,-0.0262,-0.0274,-0.0261),
    (-0.0186,-0.0173,-0.0168,-0.0168,-0.0161,-0.0143,-0.0117,-0.0091,-0.0069,-0.005,-0.002),
    (-0.0337,-0.0278,-0.0239,-0.0225,-0.0209,-0.0176,-0.0124,-0.0068,-0.0024,0.0019,0.0071),
    (-0.0464,-0.0369,-0.0305,-0.0273,-0.0248,-0.0205,-0.015,-0.0093,-0.003,0.0023,0.0084),
    (-0.0541,-0.0423,-0.0342,-0.0288,-0.0258,-0.022,-0.0174,-0.0128,-0.007,-0.0024,0.0029),
    (-0.052,-0.0401,-0.0323,-0.0269,-0.0241,-0.0217,-0.0178,-0.0176,-0.015,-0.012,-0.0071),
    (-0.0373,-0.0267,-0.0203,-0.0174,-0.0163,-0.0165,-0.0168,-0.0197,-0.021,-0.0214,-0.0199),
    (-0.0134,-0.0042,0.0008,-0.0014,-0.0033,-0.0071,-0.0135,-0.0206,-0.0272,-0.031,-0.033)],
    #CHIP=14
    [(-0.067,-0.0631,-0.0625,-0.0654,-0.0675,-0.0688,-0.0709,-0.0718,-0.0743,-0.0815,-0.0931),
    (-0.0514,-0.0405,-0.033,-0.0261,-0.0224,-0.0204,-0.0219,-0.025,-0.0314,-0.0418,-0.0566),
    (-0.0453,-0.0276,-0.0131,0.0007,0.009,0.0134,0.0123,0.0075,-0.002,-0.0155,-0.0335),
    (-0.0512,-0.0247,-0.0034,0.0145,0.0264,0.032,0.0309,0.0239,0.0124,-0.0041,-0.0261),
    (-0.053,-0.0228,0.0015,0.0231,0.0362,0.0418,0.0404,0.0325,0.0184,-0.0004,-0.0251),
    (-0.0489,-0.0175,0.0071,0.028,0.0409,0.0469,0.0444,0.0361,0.0215,0.0022,-0.0229),
    (-0.0358,-0.0083,0.0127,0.0309,0.0417,0.0467,0.0437,0.0355,0.0216,0.0039,-0.0188),
    (-0.0102,0.0087,0.0226,0.0335,0.0405,0.0428,0.0395,0.0312,0.0214,0.0077,-0.0102),
    (0.0282,0.0354,0.0392,0.0406,0.04,0.0392,0.0356,0.0303,0.0234,0.0151,0.0048),
    (0.0796,0.0761,0.0692,0.0607,0.0527,0.0479,0.0433,0.0402,0.0384,0.0358,0.0312),
    (0.1412,0.127,0.1094,0.0891,0.0731,0.064,0.058,0.0578,0.0623,0.0654,0.0665)],
    #CHIP=15
    [(-0.0044,0.0099,0.0212,0.0305,0.0362,0.0365,0.031,0.0185,-0.0005,-0.0239,-0.0527),
    (0.0168,0.0321,0.0445,0.0542,0.0611,0.0637,0.0617,0.0538,0.0395,0.0195,-0.0057),
    (0.0259,0.0423,0.0556,0.066,0.0737,0.078,0.0786,0.074,0.0635,0.0469,0.0251),
    (0.0225,0.0398,0.0538,0.0653,0.073,0.078,0.0792,0.0781,0.072,0.0574,0.0366),
    (0.0093,0.0278,0.0426,0.0543,0.0617,0.066,0.0687,0.0689,0.065,0.0514,0.0306),
    (-0.0053,0.0126,0.0271,0.0388,0.0469,0.0506,0.0522,0.0525,0.0494,0.0357,0.0141),
    (-0.017,0.0002,0.0137,0.0249,0.0316,0.0337,0.0349,0.0345,0.029,0.0137,-0.0096),
    (-0.0194,-0.0054,0.005,0.0145,0.0187,0.0196,0.0174,0.0142,0.0066,-0.0101,-0.0347),
    (-0.0065,0.0013,0.007,0.0134,0.0133,0.0091,0.0037,-0.0019,-0.0123,-0.0305,-0.0557),
    (0.0212,0.0239,0.0242,0.024,0.0189,0.0108,0.0017,-0.0072,-0.019,-0.0392,-0.0663),
    (0.0623,0.0597,0.0548,0.0457,0.0346,0.0223,0.009,-0.0034,-0.0162,-0.0383,-0.0674)],
    #CHIP=16
    [(-0.1348,-0.0982,-0.0644,-0.0334,-0.0061,0.0154,0.0264,0.0265,0.0163,0.0043,-0.0095),
    (-0.0616,-0.0353,-0.0118,0.0078,0.024,0.0357,0.0398,0.0348,0.0243,0.0114,-0.0032),
    (-0.0055,0.0105,0.0238,0.0331,0.0399,0.0435,0.0416,0.0324,0.0207,0.0069,-0.0087),
    (0.0307,0.0369,0.0412,0.0408,0.0395,0.0361,0.0275,0.0159,0.0023,-0.0116,-0.0265),
    (0.0487,0.046,0.0421,0.0347,0.0267,0.0193,0.0078,-0.0058,-0.0224,-0.0375,-0.0526),
    (0.0502,0.0417,0.0328,0.0199,0.0089,-0.0016,-0.0145,-0.0294,-0.0459,-0.0632,-0.0818),
    (0.038,0.0275,0.0169,0.0031,-0.0087,-0.0211,-0.0356,-0.0498,-0.0648,-0.0841,-0.1065),
    (0.0196,0.0108,0.0013,-0.0127,-0.0223,-0.0358,-0.0516,-0.0644,-0.08,-0.0999,-0.1246),
    (-0.0007,-0.0084,-0.0158,-0.0226,-0.0335,-0.0461,-0.0618,-0.0722,-0.0877,-0.109,-0.1359),
    (-0.0201,-0.0235,-0.0266,-0.0303,-0.0376,-0.048,-0.0625,-0.0735,-0.0889,-0.1102,-0.1371),
    (-0.0355,-0.0346,-0.0333,-0.0343,-0.0349,-0.0425,-0.0554,-0.0678,-0.0825,-0.1038,-0.1307)]]


    xcor_new = 0.
    ycor_new = 0.

    rx = 1+(xr)/204.8
    ry = 1+(yr)/204.8
    ii = int(rx)
    jj = int(ry)
    fx = rx-ii
    fy = ry-jj

    #! Bi-linear interpolation
    dx = (1-fx)*(1-fy)*xchip[chip-1][jj-1][ii-1] + (1-fx)*( fy )*xchip[chip-1][jj][ii-1] + ( fx )*(1-fy)*xchip[chip-1][jj-1][ii] + ( fx )*( fy )*xchip[chip-1][jj][ii]
    dy = (1-fx)*(1-fy)*ychip[chip-1][jj-1][ii-1] + (1-fx)*( fy )*ychip[chip-1][jj][ii-1] + ( fx )*(1-fy)*ychip[chip-1][jj-1][ii] + ( fx )*( fy )*ychip[chip-1][jj][ii]

    #! Applying the corrections (xt,yt) -> (xc,yc)
    xcor_new = xm - dx
    ycor_new = ym - dy

    return xcor_new, ycor_new


#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#!                                   !
#! 3x3 TABLE OF RESIDUALS CORRECTION !
#!                                   !
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

def vvv_gc(xr,yr,chip):
    """
    xr, yr   ! Raw coordinates
    chip     ! Chip number
    xcor, ycor ! Corrected coordinates

    tab_xy_ijk(2,3,3,16) ! Table of residuals (3x3)
    """

    #CHIP=01
    tab_xy_ijk =[[[(-5408.727,-4821.573),  (-4388.334,-4825.928),   (-3365.072,-4829.449)],
    [(-5401.372,-5839.792),   (-4382.179,-5845.294),   (-3360.094,-5849.483)],
    [(-5393.015,-6854.367),   (-4375.110,-6860.641),   (-3354.402,-6865.595)]],
    #CHIP=02
    [[(-2492.191,-4834.420),  (-1465.115,-4836.186),   (-436.910,-4836.732)],
    [(-2488.749,-5855.027),   (-1462.883,-5857.169),   (-435.959,-5857.993)],
    [(-2484.684,-6871.608),   (-1460.212,-6874.208),   (-434.827,-6875.168)]],
    #CHIP=03
    [[(435.544,-4834.487),    (1463.795,-4833.273),    (2490.922,-4830.929)],
    [(435.090,-5855.690),     (1462.074,-5854.342),    (2488.033,-5851.612)],
    [(434.503,-6872.929),     (1460.052,-6871.448),    (2484.506,-6868.215)]],
    #CHIP=04
    [[(3365.238,-4828.562),   (4388.519,-4823.736),    (5409.114,-4817.939)],
    [(3361.496,-5848.575),    (4383.751,-5842.974),    (5403.046,-5836.111)],
    [(3357.292,-6864.659),    (4378.137,-6858.546),    (5396.343,-6850.729)]],
    #CHIP=05
    [[(-5422.129, -926.753),  (-4399.713, -927.546),   (-3373.875, -928.158)],
    [(-5420.164,-1953.917),   (-4397.828,-1955.876),   (-3372.492,-1957.379)],
    [(-5416.581,-2979.515),   (-4395.031,-2982.620),   (-3370.099,-2985.154)]],
    #CHIP=06
    [[(-2500.031, -928.760),  (-1470.068, -928.978),   (-439.341, -928.711)],
    [(-2498.689,-1958.643),   (-1469.298,-1959.204),   (-438.690,-1959.313)],
    [(-2496.972,-2987.048),   (-1467.966,-2988.137),   (-438.138,-2988.353)]],
    #CHIP=07
    [[(438.275, -928.235),    (1469.182, -927.681),    (2499.094, -926.721)],
    [(438.525,-1958.849),     (1469.097,-1958.057),    (2498.544,-1956.721)],
    [(438.460,-2987.917),     (1468.556,-2986.870),    (2497.449,-2985.046)]],
    #CHIP=08
    [[(3373.144, -926.591),   (4399.015, -925.149),    (5421.906, -923.687)],
    [(3372.325,-1955.877),    (4397.908,-1953.656),    (5420.378,-1950.860)],
    [(3370.703,-2983.601),    (4395.757,-2980.453),    (5417.748,-2976.636)]],
    #CHIP=09
    [[(-5418.654, 2976.394),  (-4396.897, 2980.155),   (-3372.079, 2983.307)],
    [(-5421.467, 1950.645),   (-4399.175, 1953.192),   (-3373.644, 1955.289)],
    [(-5423.071,  923.571),   (-4400.292,  924.988),   (-3374.668,  926.082)]],
    #CHIP=10
    [[(-2495.253, 2987.442),  (-1466.276, 2987.879),   (-436.431, 2987.849)],
    [(-2497.438, 1958.776),   (-1468.054, 1958.946),   (-437.505, 1958.583)],
    [(-2499.348,  929.080),   (-1469.475,  928.671),   (-438.446,  928.051)]],
    #CHIP=11
    [[(437.221, 2987.457),    (1466.990, 2987.205),    (2495.980, 2986.359)],
    [(437.635, 1958.334),     (1468.261, 1958.316),    (2497.801, 1957.886)],
    [(438.402,  927.705),     (1469.164,  927.915),    (2499.162,  927.943)]],
    #CHIP=12
    [[(3369.337, 2985.818),   (4394.385, 2983.506),    (5416.448, 2980.442)],
    [(3371.599, 1957.980),    (4397.208, 1956.510),    (5419.710, 1954.629)],
    [(3372.870,  928.638),    (4398.900,  928.167),    (5421.793,  927.455)]],
    #CHIP=13
    [[(-5391.602, 6854.748),  (-4373.792, 6860.439),   (-3352.947, 6864.663)],
    [(-5400.681, 5840.144),   (-4381.586, 5844.934),   (-3359.542, 5848.463)],
    [(-5408.842, 4821.792),   (-4388.493, 4825.460),   (-3365.207, 4828.067)]],
    #CHIP=14
    [[(-2489.050, 6867.869),  (-1464.486, 6871.573),   (-438.999, 6873.861)],
    [(-2491.905, 5850.896),   (-1466.008, 5854.431),   (-439.012, 5856.419)],
    [(-2494.359, 4830.260),   (-1467.137, 4833.239),   (-438.863, 4835.083)]],
    #CHIP=15
    [[(434.372, 6874.212),    (1459.899, 6873.118),    (2484.354, 6870.445)],
    [(435.312, 5856.796),     (1462.303, 5856.000),    (2488.306, 5853.736)],
    [(436.047, 4835.517),     (1464.358, 4834.893),    (2491.569, 4833.001)]],
    #CHIP=16
    [[(3354.542, 6867.480),   (4375.460, 6861.426),    (5393.424, 6853.866)],
    [(3359.009, 5851.297),    (4381.247, 5845.946),    (5400.558, 5839.303)],
    [(3362.702, 4830.969),    (4386.162, 4826.595),    (5406.594, 4821.047)]]]

    #! Grid-point to use for the biquadratic interpolation
    xtab = np.empty((3,3))
    ytab = np.empty((3,3))

    for i in xrange(3):
        for j in xrange(3):
            xtab[i][j] = tab_xy_ijk[chip-1][2-j][i][0]
            ytab[i][j] = tab_xy_ijk[chip-1][2-j][i][1]
#            print tab_xy_ijk[chip-1][2-j][i][0], tab_xy_ijk[chip-1][2-j][i][1]

    xcor, ycor = basic_gc_biquad(xr,yr,chip,xtab,ytab)

    return xcor, ycor


#!!!!!!!!!!!!!!!!!!!!!!!!!!!
#!                         !
#! BIQUADRIC INTERPOLATION !
#!                         !
#!!!!!!!!!!!!!!!!!!!!!!!!!!!

def basic_gc_biquad(xr,yr,chip,xtab,ytab):
    """
    xraw, yraw ! Raw coordinates
    xcor, ycor ! Corrected coordinates
    xtab(3,3)  ! Grid-point values
    ytab(3,3)  ! Grid-point values
    """

    #! Coefficients used to perform the biquadratic interpolation
    QX = np.empty(3)
    QY = np.empty(3)

    rxtab = 1 + xr/1024.00
    rytab = 1 + yr/1024.00
    #! We rescale the grid points (1,2,3) -> (-1,0,+1)
    fxtab = rxtab - 2.0
    fytab = rytab - 2.0

    #! Nine grid points + Biquadratic interpolation = degeneracy
    for i in xrange(3):
        QX[i] = xtab[1][i] + 0.5*(xtab[2][i]-xtab[0][i])*fxtab + 0.5*(xtab[2][i]+xtab[0][i]-2*xtab[1][i])*fxtab**2.
        QY[i] = ytab[1][i] + 0.5*(ytab[2][i]-ytab[0][i])*fxtab + 0.5*(ytab[2][i]+ytab[0][i]-2*ytab[1][i])*fxtab**2.

    #! Biquadratic interpolation
    xcor = QX[1] + 0.5*(QX[2]-QX[0])*fytab + 0.5*(QX[2]+QX[0]-2*QX[1])*fytab**2
    ycor = QY[1] + 0.5*(QY[2]-QY[0])*fytab + 0.5*(QY[2]+QY[0]-2*QY[1])*fytab**2

    return xcor, ycor


os.system('rm *_gc.*')
files = glob.glob(search_text)

for file in files:

    x_in, y_in = np.genfromtxt(path+file, usecols=(x_col,y_col), skip_header=skip_header, unpack=True)
    #SACAR
    x_in = x_in[x_in < 2048]
    y_in = y_in[y_in < 2048]
    #
    x_dc = np.empty_like(x_in)
    y_dc = np.empty_like(y_in)

    for i in xrange(len(x_in)):
        x_dc[i], y_dc[i] = VIRCAM_gc_J(x_in[i], y_in[i], nchip)

    data = np.genfromtxt(path+file, skip_header=skip_header)
    data[:,x_col] = x_dc
    data[:,y_col] = y_dc

    out_file = open(path+file.replace('.','_gc.'),'w')
    np.savetxt(out_file, data, fmt='%2d %4.2f %4.2f %2.3f %1.3f %4.2f %1d %1.2f %1.3f')
    out_file.close()
